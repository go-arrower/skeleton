{{ define "admin.title" }}
    {{ if eq 1 (len .Queues) }}
        1 Queue
    {{ else }}
        {{ len .Queues }} Queues
    {{ end }}
{{ end }}


<div id="statistics" class="flex">
    <div class="max-w-md grow flex flex-col justify-center"> <!-- wrap, so the chart cen be centered vertically -->
        <div id="queues" class="h-52"></div>
    </div>
    <div class="max-w-md grow"> <!-- wrap, so the echart uses the full width and height when rendering -->
        <div id="processed" class="h-96"></div>
    </div>
</div>


<table hx-get="/admin/jobs"
       hx-trigger="every 4.5s"
       hx-swap="outerHTML"
       hx-select="#queue-list"
       hx-target="#queue-list"
       hx-disinherit="hx-target hx-select hx-swap"
       class="table-auto w-full border border-collapse text-left">
    <!-- todo add #statistics BUT js will not redraw the charts -->
    <thead class="bg-gray-100">
    <tr>
        <th scope="col" class="p-1 border border-slate-300">Queue</th>
        <th scope="col" class="p-1 border border-slate-300">State</th>
        <th scope="col" class="p-1 border border-slate-300">Pending</th>
        <th scope="col" class="p-1 border border-slate-300">Processed</th>
        <th scope="col" class="p-1 border border-slate-300">Failed</th>
        <th scope="col" class="p-1 border border-slate-300">Pending Error Rate</th>
    </tr>
    </thead>
    <tbody id="queue-list">
    {{ range .Queues }}
        {{ template "queue" . }}
    {{ end }}
    </tbody>
</table>


<script type="text/javascript">
    var queuesChart;
    var oldData
    var init = false

    var processedChart;

    async function updatePendingJobsPieChart() {
        const response = await fetch("/admin/jobs/data/pending");
        const data = await response.json();

        if (JSON.stringify(oldData) === JSON.stringify(data)) { // oder of keys is important for this form of equality check
            return
        }

        oldData = data

        queuesChart.hideLoading();
        queuesChart.setOption({
            series: [
                {
                    data: data
                }
            ]
        });
    }

    async function updateProcessedLineChart() {
        const response = await fetch("/admin/jobs/data/processed");
        const data = await response.json();

        processedChart.hideLoading();
        processedChart.setOption({
            xAxis: {
                data: data.xAxis
            },
            series: [
                {
                    data: data.series
                }
            ]
        });
    }


    document.body.addEventListener('htmx:load', function (e) {
        if (init === false) {
            initPie();
            initLine();

            init = true;
        }

        updatePendingJobsPieChart()
    });

    document.body.addEventListener('htmx:beforeOnLoad', function (e) {
        if (e.detail.pathInfo.finalRequestPath !== "/admin/jobs") { // user leaves page
            echarts.dispose(queuesChart)
            // queuesChart = undefined
            echarts.dispose(processedChart)
            // processedChart = undefined

            oldData = undefined
            document.init = false
        }
    })

    function initPie() {
        // Create the echarts instance
        queuesChart = echarts.init(document.getElementById('queues'));
        queuesChart.showLoading();

        queuesChart.setOption({
            tooltip: {
                trigger: 'item',
                formatter: '<b>{b}</b>: {c} ({d}%)'
            },
            title: {
                text: 'Pending Jobs per Queue',
                right: '25%',
            },
            series: [
                {
                    type: 'pie',
                    data: [],
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowOffsetX: 0,
                            shadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                    }
                }
            ],
            // roseType: 'area'
        });
    }

    function initLine() {
        processedChart = echarts.init(document.getElementById('processed'));
        processedChart.showLoading();

        processedChart.setOption({
            tooltip: {
                trigger: 'axis',
                // axisPointer: { type: 'cross' }
            },
            title: {
                text: 'Processed Jobs',
                right: '30%',
            },
            xAxis: {
                type: 'category',
            },
            yAxis: {
                type: 'value',
                name: 'Jobs',
            },
            series: [
                {
                    type: 'line',
                    smooth: true
                }
            ],
            toolbox: {
                feature: {
                    myTool1: {
                        show: true,
                        title: 'Reload',
                        icon: 'path://M432.45,595.444c0,2.177-4.661,6.82-11.305,6.82c-6.475,0-11.306-4.567-11.306-6.82s4.852-6.812,11.306-6.812C427.841,588.632,432.452,593.191,432.45,595.444L432.45,595.444z M421.155,589.876c-3.009,0-5.448,2.495-5.448,5.572s2.439,5.572,5.448,5.572c3.01,0,5.449-2.495,5.449-5.572C426.604,592.371,424.165,589.876,421.155,589.876L421.155,589.876z M421.146,591.891c-1.916,0-3.47,1.589-3.47,3.549c0,1.959,1.554,3.548,3.47,3.548s3.469-1.589,3.469-3.548C424.614,593.479,423.062,591.891,421.146,591.891L421.146,591.891zM421.146,591.891',
                        onclick: function () {
                            updateProcessedLineChart();
                        }
                    },
                }
            }
        });

        updateProcessedLineChart();
    }
</script>


{{ define "queue"}}
    <tr class="odd:bg-white even:bg-slate-50">
        <td class="p-1">
            <a href="/admin/jobs/{{ .QueueName }}" class="font-medium">{{ .QueueName }}</a>
        </td>
        <td class="p-1">
            {{ if eq 0 .PendingJobs }}
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                     stroke="currentColor" class="w-6 h-6 text-green-600">
                    <title>No jobs, waiting</title>
                    <path stroke-linecap="round" stroke-linejoin="round"
                          d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
            {{ else if eq 0 .AvailableWorkers }}
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
                     class="w-6 h-6 text-orange-600">
                    <title>No workers</title>
                    <path fill-rule="evenodd"
                          d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zM9 8.25a.75.75 0 00-.75.75v6c0 .414.336.75.75.75h.75a.75.75 0 00.75-.75V9a.75.75 0 00-.75-.75H9zm5.25 0a.75.75 0 00-.75.75v6c0 .414.336.75.75.75H15a.75.75 0 00.75-.75V9a.75.75 0 00-.75-.75h-.75z"
                          clip-rule="evenodd"/>
                </svg>
            {{ else }}
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                     stroke="currentColor" class="w-6 h-6 text-green-600">
                    <title>Processing</title>
                    <path stroke-linecap="round" stroke-linejoin="round"
                          d="M11.25 4.5l7.5 7.5-7.5 7.5m-6-15l7.5 7.5-7.5 7.5"/>
                </svg>
            {{ end }}
        </td>
        <td class="p-1">{{ .PendingJobs }}</td>
        <td class="p-1">{{ .ProcessedJobs }}</td>
        <td class="p-1">{{ .FailedJobs }}</td>
        <td class="p-1">{{ .PendingJobsErrorRate }}%</td>
    </tr>
{{ end }}